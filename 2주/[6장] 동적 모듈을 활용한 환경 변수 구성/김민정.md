# [6ì¥] ë™ì  ëª¨ë“ˆì„ í™œìš©í•œ í™˜ê²½ ë³€ìˆ˜ êµ¬ì„±

# 6.1 ë™ì  ëª¨ë“ˆ

- ë™ì  ëª¨ë“ˆ(dynamic module)ì€ ëª¨ë“ˆì´ ìƒì„±ë  ë•Œ ë™ì ìœ¼ë¡œ ì–´ë– í•œ ë³€ìˆ˜ë“¤ì´ ì •í•´ì§„ë‹¤.
- ëª¨ë“ˆ ì¸ìŠ¤í„´ìŠ¤ ë§ˆë‹¤ ë‹¤ë¥´ê²Œ ê²°ì •ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒë“¤ì„ ì†Œë¹„ ëª¨ë“ˆì—ì„œ ì§€ì •í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì½”ë“œê°€ ê°„ê²°í•´ ì§„ë‹¤.
- ë™ì  ëª¨ë“ˆì€ ì •ì  ëª¨ë“ˆê³¼ í•¨ê»˜ ì œê³µí•  ìˆ˜ ìˆë‹¤.
- ë™ì  ëª¨ë“ˆì˜ ëŒ€í‘œì ì¸ ì˜ˆë¡œ ë³´í†µ `Config`ë¼ê³  ë¶€ë¥´ëŠ” ëª¨ë“ˆì´ ìˆë‹¤.

<br />

# 6.2 dotenvë¥¼ ì´ìš©í•œ Config ì„¤ì •

- **dotenv** : ì‹¤í–‰ í™˜ê²½(`local/development`,`stage`,`production`)ì— ë”°ë¼ ë‹¬ë¼ì§€ëŠ” í™˜ê²½ ë³€ìˆ˜ë“¤ì„ .env í™•ì¥ìë¥¼ ê°€ì§„ íŒŒì¼ì— ì €ì¥í•´ ë‘ê³  ì„œë²„ê°€ êµ¬ë™ ë  ë•Œ ì´ íŒŒì¼ì„ ì½ì–´ í•´ë‹¹ ê°’ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •í•´ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.

```bash
$ npm i --save dotenv
$ npm i --save-dev @types/dotenv
```

## ì˜ˆì œ

```bash
// .development.env ( ë¡œì»¬ í™˜ê²½ )
DATABBASE_HOST=loal

// .stage.env ( ìŠ¤í…Œì´ì§€ í™˜ê²½ )
DATABBASE_HOST=stage-reader.dextto.com

// .production.env ( í”„ë¡œë•ì…˜ í™˜ê²½ )
DATABBASE_HOST=prod-reader.dextto.com
```

> ğŸ’¡ **í™˜ê²½ ë³€ìˆ˜ ì €ì¥**
> â€¢ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì€ ì‹œí¬ë¦¿ í‚¤ì™€ ê°™ì€ ë¯¼ê°í•œ ì •ë³´ê°€ ì €ì¥ë˜ê¸° ë•Œë¬¸ì— .gitignore íŒŒì¼ì— ì¶”ê°€í•˜ì—¬ ì €ì¥ì†Œì— ë°°í¬ë˜ì§€ ì•Šë„ë¡ í•œë‹¤.
> â€¢ ì„œë²„ê°€ êµ¬ë™ë  ë•Œ AWSì˜ Secret Managerì—ì„œ ê°’ì„ ì½ì–´ì„œ í”„ë¡œë¹„ì €ë‹ ê³¼ì •ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë„£ì–´ ì¤„ ìˆ˜ ìˆë‹¤.

- Node.jsëŠ” `NODE_ENV`ë¼ëŠ” í™˜ê²½ë³€ìˆ˜ë¥¼ í™œìš©í•˜ì—¬ ì„œë²„ì˜ í™˜ê²½ì„ êµ¬ë¶„í•œë‹¤.

```bash
ìœˆë„ìš° : set NODE_ENV=development
ë¦¬ëˆ…ìŠ¤ ë˜ëŠ” macOS : export NODE_ENV=development
```

- `npm run start:dev` ëª…ë ¹ì´ ìˆ˜í–‰ë  ë•Œ NODE_ENVê°€ developmentë¡œ ì„¤ì •ë˜ë„ë¡ ìˆ˜ì • í•œë‹¤.

```json
"scripts": {
	"prebuild": "rimraf dist",
	...,
	"start:dev": "npm run prebuild && NODE_ENV=development nest start --watch",
}
```

- .env íŒŒì¼ì„ `NODE_ENV`ì— ë”°ë¼ ì½ë„ë¡ í•œë‹¤.

```tsx
import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";
import * as dotenv from "dotenv";
import * as path from "path";

dotenv.config({
  // NODE_ENVê°’ì— ë”°ë¼ .env ê²½ë¡œë¥¼ ë‹¤ë¥´ê²Œ ì§€ì •.
  path: path.resolve(
    process.env.NODE_ENV === "production"
      ? ".production.env"
      : process.env.NODE_ENV === "stage"
      ? ".stage.env"
      : ".development.env"
  ),
});

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(3000);
}
bootstrap();
```

```tsx
@Controller()
export class AppController {
  @Get()
  getHello(): string {
    return process.env.DATABASE_HOST;
  }
}
```

<br />

# 6.3 Nestì—ì„œ ì œê³µí•˜ëŠ” Config íŒ¨í‚¤ì§€

- NestëŠ” dotenvë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ í™œìš©í•˜ëŠ” `@nestjs/config` íŒ¨í‚¤ì§€ë¥¼ í™œìš©í•˜ì—¬ CnfigModuleì„ ë™ì ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

```bash
$ npm i --save @nestjs/config
```

```tsx
import { ConfigModule } from '@nestjs/config';

@Module({
	imports: [ConfigModule.forRoot()],
	...
})
export class APPModule {}
```

- **forRoot ë©”ì„œë“œ** :
  - DynamicModuleì„ ë¦¬í„´í•˜ëŠ” ì •ì  ë©”ì„œë“œë‹¤.
  - ê´€ë¡€ìƒ forRoot ë˜ëŠ” registerë¥¼ ì‚¬ìš©í•œë‹¤.
  - ë¹„ë™ê¸° í•¨ìˆ˜ì¼ ë•ŒëŠ” forRootAsync, registerAsyncë¡œ í•œë‹¤.

```tsx
static forRoot(options?: ConfigModuleOptions): DynamicModule;
```

- ConfigModuleì€ ì†Œë¹„ ëª¨ë“ˆì´ ì›í•˜ëŠ” ì˜µì…˜ê°’ì„ ì „ë‹¬í•˜ì—¬ ë™ì ìœ¼ë¡œ configModuleì„ ìƒì„±í•œë‹¤.

```tsx
import { ConfigModule } from '@nestjs/core';

@Module({
	imports: [ConfigModule.forRoot({
		envFilePath: (process.env.NODE_ENV === 'production') ? '.production.env'
		: (process.env.NODE_ENV === 'stage') ? '.stage.env' : '.development.env'
	})],
	controllers: [AppController],
	providers: [AppService, ConfigService],
	...
})
export class APPModule {}
```

- ConfigModuleOptions

```tsx
export interface ConfigModuleOptions<
  ValidationOptions extends Record<string, any> = Record<string, any>
> {
  // ì„¤ì • ê°’ì„ ìºì‹±í• ì§€ ì—¬ë¶€ (ì„±ëŠ¥ ìµœì í™”ì— ë„ì›€)
  cache?: boolean;

  // ëª¨ë“ˆì„ ì „ì—­ì ìœ¼ë¡œ ë“±ë¡í• ì§€ ì—¬ë¶€ (trueë©´ ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ import ë¶ˆí•„ìš”)
  isGlobal?: boolean;

  // .env íŒŒì¼ì„ ë¬´ì‹œí• ì§€ ì—¬ë¶€ (trueë©´ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë¡œë“œí•˜ì§€ ì•ŠìŒ)
  ignoreEnvFile?: boolean;

  // ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¬´ì‹œí• ì§€ ì—¬ë¶€ (trueë©´ í”„ë¡œì„¸ìŠ¤ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
  ignoreEnvVars?: boolean;

  // í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ê²½ë¡œ (ë‹¨ì¼ ë¬¸ìì—´ ë˜ëŠ” ì—¬ëŸ¬ íŒŒì¼ ê²½ë¡œ ë°°ì—´)
  envFilePath?: string | string[];

  // ì„¤ì • ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ (í™˜ê²½ ë³€ìˆ˜ë¥¼ ë°›ì•„ ê²€ì¦ í›„ ë°˜í™˜)
  validate?: (config: Record<string, any>) => Record<string, any>;

  // ì‚¬ì „ ì •ì˜ëœ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì—¬ë¶€
  validatePredefined?: boolean;

  // process.env ê°ì²´ ì²˜ë¦¬ ê±´ë„ˆë›°ê¸° ì—¬ë¶€
  skipProcessEnv?: boolean;

  // Joiì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©í•œ ìœ íš¨ì„± ê²€ì‚¬ ìŠ¤í‚¤ë§ˆ
  validationSchema?: any;

  // ìœ íš¨ì„± ê²€ì‚¬ì— ì‚¬ìš©í•  ì˜µì…˜ (allowUnknown, abortEarly ë“±)
  validationOptions?: ValidationOptions;

  // ì»¤ìŠ¤í…€ ì„¤ì • ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ ë°°ì—´ (ëª¨ë“ˆí™”ëœ ì„¤ì • ê´€ë¦¬)
  load?: Array<ConfigFactory | Promise<ConfigFactory>>;

  // í™˜ê²½ ë³€ìˆ˜ ë‚´ ì¤‘ì²© ë³€ìˆ˜ í™•ì¥ ì—¬ë¶€ (${VAR}ì™€ ê°™ì€ êµ¬ë¬¸ ì§€ì›)
  expandVariables?: boolean | DotenvExpandOptions;
}
```

# 6.4 ìœ ì € ì„œë¹„ìŠ¤ì— í™˜ê²½ ë³€ìˆ˜ êµ¬ì„±í•˜ê¸°

- í•˜ë“œì½”ë”©ë˜ì–´ ìˆëŠ” ë³€ìˆ˜ë“¤ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë‹¤ë¤„ ë³¸ë‹¤.
- í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

```bash
$ npm i @nestjs/config
$ npm i joi
```

```bash
# .development.env

EMAIL_SERVICE=Gmail
EMAIL_AUTH_USER=YSER_GMAIL
EMAIL_AUTH_PASSWORD=YOUR_GMAIL_PASSWORD
EMAIL_BASE_USER=http://localhost:3000
```

## 6.4.1 ì»¤ìŠ¤í…€ Config íŒŒì¼ ì‘ì„±

- `.env`íŒŒì¼ì— ì„ ì–¸ë˜ì–´ ìˆì§€ë§Œ, ì˜ë¯¸ ìˆëŠ” ë‹¨ìœ„ë¡œ ë¬¶ì–´ì„œ ì²˜ë¦¬í•˜ê³  ì‹¶ì€ ê²½ìš°, `@nestjs/config` íŒ¨í‚¤ì§€ì—ì„œ ì œê³µí•˜ëŠ” ConfigModuleì„ ì´ìš©í•˜ì—¬ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

```tsx
// src/config/emailConfig.ts

import { registerAs } from "@nestjs/config";

export default frgisterAs('email', () => ({
	service: process.env.EMAIL_SERVICE,
	auth: {
		user: process.env.EMAIL_AUTH_USER,
		pass: process.env.EMAIL_AUTH_PASSWORD,
	},
	baseUrl: : process.env.EMAIL_BASE_USER,
})
```

- `registerAs` ì— ëŒ€í•œ ë‚´ìš©ì€ [NestJS ê³µì‹ ë¬¸ì„œ](https://docs.nestjs.com/techniques/configuration)ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.

# ì˜ì¡´ì„± ì£¼ì…ê³¼ ì œì–´ ë°˜ì „

- ê°ì²´ ì§€í–¥ ì›ì¹™ê³¼ SOLID ì„¤ê³„ ì›ì¹™, ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜ ë“±ì„ í•™ìŠµí•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ìë£Œë¡œ ë¡œë²„íŠ¸ ë§ˆí‹´ì˜ `í´ë¦° ì•„í‚¤í…ì²˜`ë¥¼ ì¶”ì²œí•œë‹¤.
- SOLID ì›ì¹™ì˜ Dì— í•´ë‹¹í•˜ëŠ” ì˜ì¡´ ê´€ê³„ ì—­ì „ ì›ì¹™ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” ì œì–´ ë°˜ì „ ì»¨í…Œì´ë„ˆë¼ëŠ” ê¸°ìˆ ì´ í•„ìš”í•˜ë‹¤.

<br />

# â“ SOLIDë€?

| ì›ì¹™ | ì´ë¦„                            | í•µì‹¬ ê°œë… ìš”ì•½                           |
| ---- | ------------------------------- | ---------------------------------------- |
| S    | Single Responsibility Principle | í•˜ë‚˜ì˜ ì±…ì„ë§Œ ê°€ì ¸ì•¼ í•¨                  |
| O    | Open/Closed Principle           | í™•ì¥ì—” ì—´ë ¤ ìˆê³ , ìˆ˜ì •ì—” ë‹«í˜€ ìˆì–´ì•¼ í•¨  |
| L    | Liskov Substitution Principle   | ìì‹ í´ë˜ìŠ¤ëŠ” ë¶€ëª¨ë¥¼ ëŒ€ì²´í•  ìˆ˜ ìˆì–´ì•¼ í•¨ |
| I    | Interface Segregation Principle | ì¸í„°í˜ì´ìŠ¤ëŠ” ì‘ê²Œ ë‚˜ëˆ„ì–´ì•¼ í•¨            |
| D    | Dependency Inversion Principle  | ì¶”ìƒí™”ì— ì˜ì¡´í•´ì•¼ í•¨                     |

## 1ï¸âƒ£ S - **ë‹¨ì¼ ì±…ì„ ì›ì¹™ (SRP)**

> "í´ë˜ìŠ¤ëŠ” í•˜ë‚˜ì˜ ì±…ì„ë§Œ ê°€ì ¸ì•¼ í•œë‹¤."

- í•˜ë‚˜ì˜ í´ë˜ìŠ¤ëŠ” í•˜ë‚˜ì˜ ì´ìœ ë¡œë§Œ ë³€ê²½ë˜ì–´ì•¼ í•œë‹¤.
  >

```tsx
// ğŸ’© ë‚˜ìœ ì˜ˆ
class UserService {
  createUser() {
    /* ìœ ì € ìƒì„± */
  }
  sendEmail() {
    /* ì´ë©”ì¼ ë°œì†¡ */
  } // ì±…ì„ì´ ë‹¤ë¦„!
}

// ğŸŒŸì¢‹ì€ ì˜ˆ
class UserService {
  createUser() {
    /* ìœ ì € ìƒì„± */
  }
}

class EmailService {
  sendEmail() {
    /* ì´ë©”ì¼ ë°œì†¡ */
  }
}
```

## 2ï¸âƒ£ O - **ê°œë°©-íì‡„ ì›ì¹™ (OCP)**

> "ì½”ë“œëŠ” í™•ì¥ì—ëŠ” ì—´ë ¤ ìˆì–´ì•¼ í•˜ê³ , ìˆ˜ì •ì—ëŠ” ë‹«í˜€ ìˆì–´ì•¼ í•œë‹¤."

- ê¸°ëŠ¥ì„ ì¶”ê°€í•  ë• ê¸°ì¡´ ì½”ë“œë¥¼ **ìˆ˜ì •í•˜ì§€ ë§ê³ ** í™•ì¥í•´ì„œ ëŒ€ì‘í•œë‹¤.
  >

```tsx
// ğŸ’© ë‚˜ìœ ì˜ˆ
class DiscountService {
  getDiscount(type: string) {
    if (type === "vip") return 0.2;
    if (type === "regular") return 0.1;
    // ìƒˆ íƒ€ì… ì¶”ê°€í•˜ë ¤ë©´ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì•¼ í•¨
  }
}

// ğŸŒŸì¢‹ì€ ì˜ˆ
interface DiscountStrategy {
  getDiscount(): number;
}

class VipDiscount implements DiscountStrategy {
  getDiscount() {
    return 0.2;
  }
}

class RegularDiscount implements DiscountStrategy {
  getDiscount() {
    return 0.1;
  }
}

class DiscountService {
  constructor(private strategy: DiscountStrategy) {}
  getDiscount() {
    return this.strategy.getDiscount();
  }
}
```

## 3ï¸âƒ£ L - **ë¦¬ìŠ¤ì½”í”„ ì¹˜í™˜ ì›ì¹™ (LSP)**

> "ìì‹ í´ë˜ìŠ¤ëŠ” ë¶€ëª¨ í´ë˜ìŠ¤ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤."

- ìƒì†ë°›ì€ í´ë˜ìŠ¤ëŠ” ë¶€ëª¨ì™€ **í˜¸í™˜ë˜ì–´ì•¼ í•œë‹¤.**
  >

```tsx
// ğŸ’© ë‚˜ìœ ì˜ˆ
class Bird {
  fly() {
    console.log("flying");
  }
}

class Ostrich extends Bird {
  // OstrichëŠ” Birdë¥¼ ìƒì†ë°›ì•˜ì§€ë§Œ fly()ë¥¼ ëª» ì“°ë‹ˆ, ëŒ€ì²´ê°€ ì•ˆ ë¨ âŒ
  fly() {
    throw new Error("I cannot fly");
  }
}

// ğŸŒŸì¢‹ì€ ì˜ˆ
class Bird {}

class FlyingBird extends Bird {
  fly() {
    console.log("flying");
  }
}

class Ostrich extends Bird {
  walk() {
    console.log("walking");
  }
}
```

## 4ï¸âƒ£ I - **ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬ ì›ì¹™ (ISP)**

> "ì¸í„°í˜ì´ìŠ¤ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë©”ì„œë“œì— ì˜ì¡´í•˜ì§€ ì•Šë„ë¡ ì‘ê²Œ ë‚˜ëˆ ì•¼ í•œë‹¤."

- í´ë¼ì´ì–¸íŠ¸ëŠ” ìì‹ ì´ **ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•˜ë©´ ì•ˆ ë¨**
  >

```tsx
// ğŸ’© ë‚˜ìœ ì˜ˆ
interface Animal {
  fly(): void;
  swim(): void;
}

class Dog implements Animal {
  fly() {
    throw new Error("Cannot fly");
  }
  swim() {
    console.log("swimming");
  }
}

// ğŸŒŸì¢‹ì€ ì˜ˆ
interface Swimmer {
  swim(): void;
}

interface Flyer {
  fly(): void;
}

class Dog implements Swimmer {
  swim() {
    console.log("swimming");
  }
}
```

## 5ï¸âƒ£ D - **ì˜ì¡´ ì—­ì „ ì›ì¹™ (DIP)**

> "ìƒìœ„ ëª¨ë“ˆì€ í•˜ìœ„ ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šê³ , ì¶”ìƒí™”ì— ì˜ì¡´í•´ì•¼ í•œë‹¤."

- í´ë˜ìŠ¤ëŠ” **êµ¬ì²´ì ì¸ êµ¬í˜„ë³´ë‹¨ ì¸í„°í˜ì´ìŠ¤(ì¶”ìƒí™”)** ì— ì˜ì¡´í•´ì•¼ í•¨
  >

```tsx
// ğŸ’© ë‚˜ìœ ì˜ˆ
class MySQLDatabase {
  query(sql: string) {
    /* ... */
  }
}

class UserService {
  private db = new MySQLDatabase(); // êµ¬ì²´ êµ¬í˜„ì— ì˜ì¡´ âŒ
}

// ğŸŒŸì¢‹ì€ ì˜ˆ
interface Database {
  query(sql: string): any;
}

class MySQLDatabase implements Database {
  query(sql: string) {
    /* ... */
  }
}

class UserService {
  constructor(private db: Database) {} // ì¶”ìƒí™”ì— ì˜ì¡´ âœ…
}
```
