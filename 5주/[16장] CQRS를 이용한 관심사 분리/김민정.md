# [16ì¥] CQRSë¥¼ ì´ìš©í•œ ê´€ì‹¬ì‚¬ ë¶„ë¦¬

# 16.1 CQRS íŒ¨í„´

- CQRS(Command Query Responsibility Separation) íŒ¨í„´
- ì‹œìŠ¤í…œì—ì„œ ì½ê¸°(ì¡°íšŒ) ì™€ ì“°ê¸°(ëª…ë ¹) ì˜ ì±…ì„ì„ ëª…í™•íˆ ë¶„ë¦¬í•˜ëŠ” ì•„í‚¤í…ì²˜ íŒ¨í„´
- ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ, ê³ ì„±ëŠ¥ ìš”êµ¬ ì‚¬í•­ì´ ìˆëŠ” í™˜ê²½, í˜¹ì€ ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì§„ ë„ë©”ì¸ì— ì í•©.

## ğŸ§© í•µì‹¬ ê°œë…

| ê°œë…        | ì„¤ëª…                                                                                            |
| ----------- | ----------------------------------------------------------------------------------------------- |
| **Command** | ë°ì´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ìš”ì²­ (ì˜ˆ: ìƒì„±, ìˆ˜ì •, ì‚­ì œ) â†’ ë¶€ì‘ìš© ìˆìŒ, ê²°ê³¼ ì—†ìŒ (void ë˜ëŠ” ID ë°˜í™˜ ì •ë„) |
| **Query**   | ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ìš”ì²­ (ì˜ˆ: ëª©ë¡, ìƒì„¸ ì¡°íšŒ) â†’ ë¶€ì‘ìš© ì—†ìŒ, ê²°ê³¼ë§Œ ë°˜í™˜                         |

<p align="center">
 <img width=300 src="../../assets/kmj/5/image.png" > 
 <p align="center"><em> > ì¶œì²˜ : [ë§ˆí‹´ íŒŒìš¸ëŸ¬ ë¸”ë¡œê·¸](https://martinfowler.com/bliki/CQRS.html)</em></p>
  </p> 


## ğŸ› ï¸ CQRSë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 

### ì¥ì 

- **ê´€ì‹¬ì‚¬ì˜ ë¶„ë¦¬ (Separation of Concerns):** ì¡°íšŒì™€ ëª…ë ¹ì˜ ì±…ì„ ë¶„ë¦¬
- **í™•ì¥ì„± (Scalability):** ì½ê¸°ì™€ ì“°ê¸°ë¥¼ ë…ë¦½ì ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥
- **ì„±ëŠ¥ ìµœì í™”:** ì½ê¸°ì—ëŠ” ìºì‹œ, ì½ê¸° ì „ìš© DB, ë³µì¡í•œ Projection ë“±ì„ ì‚¬ìš© ê°€ëŠ¥
- **ë³µì¡í•œ ë„ë©”ì¸ì— ì í•©:** ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„(DDD)ì™€ ê¶í•©ì´ ì¢‹ìŒ

### ë‹¨ì 

- **ë³µì¡ì„± ì¦ê°€:** ì½ê¸°/ì“°ê¸° ëª¨ë¸ì„ ë”°ë¡œ ìœ ì§€í•´ì•¼ í•˜ë¯€ë¡œ êµ¬í˜„ì´ ë³µì¡
- **ì¼ê´€ì„± ë¬¸ì œ:** ìµœì¢… ì¼ê´€ì„±(Eventual Consistency) êµ¬ì¡°ë¥¼ ê³ ë ¤í•´ì•¼ í•¨

## ğŸ§± ê¸°ë³¸ êµ¬ì¡° (NestJS ì˜ˆì‹œ ê¸°ë°˜)

```
src/
  â””â”€â”€ application/
        â”œâ”€â”€ commands/
        â”‚     â””â”€â”€ create-user.command.ts
        â”‚     â””â”€â”€ handlers/create-user.handler.ts
        â””â”€â”€ queries/
              â””â”€â”€ get-user.query.ts
              â””â”€â”€ handlers/get-user.handler.ts
```

### âœ… ëª…ë ¹ (Command)

```tsx
// create-user.command.ts
export class CreateUserCommand {
  constructor(
    public readonly email: string,
    public readonly password: string
  ) {}
}
```

```tsx
// create-user.handler.ts
@CommandHandler(CreateUserCommand)
export class CreateUserHandler implements ICommandHandler<CreateUserCommand> {
  constructor(private readonly userRepository: UserRepository) {}

  async execute(command: CreateUserCommand): Promise<void> {
    const user = new User(command.email, command.password);
    await this.userRepository.save(user);
  }
}
```

### âœ… ì¡°íšŒ (Query)

```tsx
// get-user.query.ts
export class GetUserQuery {
  constructor(public readonly userId: string) {}
}
```

```tsx
// get-user.handler.ts
@QueryHandler(GetUserQuery)
export class GetUserHandler implements IQueryHandler<GetUserQuery> {
  constructor(private readonly userReadRepository: UserReadRepository) {}

  async execute(query: GetUserQuery): Promise<UserDto> {
    return await this.userReadRepository.findById(query.userId);
  }
}
```

# CQRS with @nestjs/cqrs

```bash
$ npm i @nestjs/cqrs
```

## âœ… ì–¸ì œ CQRSë¥¼ ì¨ì•¼ í• ê¹Œ?

**ì í•©í•œ ê²½ìš°:**

- ì½ê¸°/ì“°ê¸° ë¹„ìœ¨ì´ ê·¹ë‹¨ì ìœ¼ë¡œ ì°¨ì´ë‚¨
- ë³µì¡í•œ ì“°ê¸° ë¡œì§ê³¼ ë‹¨ìˆœí•œ ì½ê¸° ë¡œì§ì´ ê³µì¡´í•¨
- ë©€í‹° DB, ë©€í‹° íŒ€, ë©€í‹° ì„œë¹„ìŠ¤ í™˜ê²½
- í™•ì¥ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ê°€ ì¤‘ìš”í•¨

**ë¶€ì í•©í•œ ê²½ìš°:**

- ë‹¨ìˆœí•œ CRUD ì• í”Œë¦¬ì¼€ì´ì…˜
- ë¹ ë¥¸ MVP ê°œë°œì´ ëª©ì ì¼ ë•Œ
