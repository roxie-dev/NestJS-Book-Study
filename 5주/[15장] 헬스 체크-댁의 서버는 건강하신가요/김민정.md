# [15ì¥] í—¬ìŠ¤ ì²´í¬: ëŒì˜ ì„œë²„ëŠ” ê±´ê°•í•˜ì‹ ê°€ìš”

- `í—¬ìŠ¤ ì²´í¬(Health Check)`ë€ : í˜„ì¬ ì„œë¹„ìŠ¤ê°€ ê±´ê°•í•œ ìƒíƒœì¸ì§€ í•­ìƒ ì²´í¬í•˜ê³  ìˆëŠ” ì¥ì¹˜
- NestëŠ” Terminus(@nestjs/terminus) í—¬ìŠ¤ ì²´í¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì œê³µí•œë‹¤.

## ğŸ‹ï¸@nestjs/terminus

- ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒíƒœë¥¼ ì‰½ê²Œ ì ê²€í•˜ê³  ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ì˜ ì—°ê²° ìƒíƒœ(ë°ì´í„°ë² ì´ìŠ¤, ìºì‹œ, ì™¸ë¶€ API ë“±)ë¥¼ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤.

## ğŸ”§ ì£¼ìš” ëª©ì 

- ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ **ë¼ì´ë¸Œë‹ˆìŠ¤(Liveness)** ì™€ **ë ˆë””ë‹ˆìŠ¤(Readiness)** ì²´í¬
- Kubernetes ê°™ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ í”Œë«í¼ì—ì„œ **í—¬ìŠ¤ í”„ë¡œë¸Œìš© ì—”ë“œí¬ì¸íŠ¸ ì œê³µ**
- ì™¸ë¶€ ì˜ì¡´ì„±(DB, Redis, ì™¸ë¶€ API ë“±)ì˜ ì—°ê²° ìƒíƒœ í™•ì¸
- ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ì„œë¹„ìŠ¤ ê°„ì˜ ì‹ ë¢° ê°€ëŠ¥í•œ ìƒíƒœ ê³µìœ 

# 15.1 Terminus ì ìš©

```bash
npm install @nestjs/terminus
```

# 15.2 í—¬ìŠ¤ ì²´í¬

```tsx
import { Controller, Get } from "@nestjs/common";
import {
  HealthCheckService,
  HttpHealthIndicator,
  HealthCheck,
} from "@nestjs/terminus";

@Controller("health")
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private http: HttpHealthIndicator
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () => this.http.pingCheck("docs", "https://docs.nestjs.com"),
    ]);
  }
}
```

## ğŸ” ì§€ì›ë˜ëŠ” í—¬ìŠ¤ ì¸ë””ì¼€ì´í„°

`@nestjs/terminus`ì—ì„œ ì œê³µí•˜ëŠ” ì¸ë””ì¼€ì´í„°:

| ì¸ë””ì¼€ì´í„°                | ê¸°ëŠ¥ ì„¤ëª…                   |
| ------------------------- | --------------------------- |
| `HttpHealthIndicator`     | ì™¸ë¶€ API ì‘ë‹µ í™•ì¸          |
| `TypeOrmHealthIndicator`  | DB ì—°ê²° ìƒíƒœ í™•ì¸ (TypeORM) |
| `MongooseHealthIndicator` | MongoDB ì—°ê²° ìƒíƒœ í™•ì¸      |
| `RedisHealthIndicator`    | Redis ì—°ê²° ìƒíƒœ í™•ì¸        |
| `GRPCHealthIndicator`     | gRPC ì—°ê²° ìƒíƒœ í™•ì¸         |
| `DiskHealthIndicator`     | ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§      |

# 15.3 TypeOrm í—¬ìŠ¤ ì²´í¬

- ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë° ìœ ìš©í•˜ë‹¤,

```bash
$ npm install @nestjs/terminus
```

```tsx
// health.controller.ts

import { Controller, Get } from "@nestjs/common";
import {
  HealthCheck,
  HealthCheckService,
  TypeOrmHealthIndicator,
} from "@nestjs/terminus";

@Controller("health")
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private db: TypeOrmHealthIndicator
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () => this.db.pingCheck("database"), // ì—°ê²° ì—¬ë¶€ í™•ì¸
    ]);
  }
}
```

```tsx
// health ê²½ë¡œë¡œ GET ìš”ì²­ ì‹œ DB ìƒíƒœë¥¼ í¬í•¨í•œ JSON ì‘ë‹µ
{
  "status": "ok",
  "info": {
    "database": {
      "status": "up"
    }
  }
}
```

# 15.4 ì»¤ìŠ¤í…€ ìƒíƒœ í‘œì‹œê¸°

NestJS í™˜ê²½ì—ì„œ `HealthIndicator`ë¥¼ ìƒì†ë°›ì•„ **ì§ì ‘ ì»¤ìŠ¤í…€ ìƒíƒœ í‘œì‹œê¸°(Health Indicator)** ë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒì€, ê¸°ë³¸ ì œê³µë˜ëŠ” ì§€í‘œ ì´ì™¸ì˜ ë™ì‘ì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ê±°ë‚˜, íŠ¹ì • ë¡œì§ì„ ì‚½ì…í•˜ê³  ì‹¶ì„ ë•Œ ìœ ìš©í•˜ë‹¤.

```tsx
// database.health.ts
import { Injectable } from "@nestjs/common";
import {
  HealthIndicator,
  HealthIndicatorResult,
  HealthCheckError,
} from "@nestjs/terminus";
import { DataSource } from "typeorm";

@Injectable()
export class CustomTypeOrmHealthIndicator extends HealthIndicator {
  constructor(private readonly dataSource: DataSource) {
    super();
  }

  async isHealthy(key: string = "database"): Promise<HealthIndicatorResult> {
    try {
      // ì‹¤ì œ ì—°ê²° ì¿¼ë¦¬ ì‹¤í–‰
      await this.dataSource.query("SELECT 1");

      const result = this.getStatus(key, true);
      return result;
    } catch (err) {
      const result = this.getStatus(key, false, {
        message: "Database connection failed",
        error: err.message,
      });

      throw new HealthCheckError("Database health check failed", result);
    }
  }
}
```

```tsx
// health.controller.ts
import { Controller, Get } from "@nestjs/common";
import { HealthCheck, HealthCheckService } from "@nestjs/terminus";
import { CustomTypeOrmHealthIndicator } from "./database.health";

@Controller("health")
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private customDb: CustomTypeOrmHealthIndicator
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([() => this.customDb.isHealthy("database")]);
  }
}
```

```tsx
// ì‹¤íŒ¨ ì‹œ:
{
  "status": "error",
  "error": {
    "database": {
      "status": "down",
      "message": "Database connection failed",
      "error": "ECONNREFUSED..."
    }
  }
}
```
