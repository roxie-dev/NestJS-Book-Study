# [14ì¥] íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§

# 14.1 @nestjs/schedule íŒ¨í‚¤ì§€

- ì£¼ê¸°ì  ë°˜ë³µ ì‘ì—…ì„ íƒœìŠ¤í¬(Task) ë˜ëŠ” ë°°ì¹˜(Batch) = ì¼ê´„ì²˜ë¦¬ ë¼ê³  ë¶€ë¥¸ë‹¤.
- íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§ì„ ì˜ í™œìš©í•˜ë©´ íŠ¹ì • ê¸°ê°„ë§ˆë‹¤ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” ê·€ì°®ì€ ì‘ì—…ì„ ì‹ ê²½ ì“°ì§€ ì•Šì•„ë„ ëœë‹¤.
- ê´‘ê³  ë©”ì¼ì„ ë‹¤ìŒë‚  ì•„ì¹¨ 7ì‹œì— ë³´ë‚´ë„ë¡ í•˜ëŠ” 1íšŒì„± íƒœìŠ¤í¬ë¥¼ ë§Œë“¤ ìˆ˜ë„ ìˆë‹¤.
- ë¦¬ëˆ…ìŠ¤ì—ëŠ” íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§ì„ ë‹´ë‹¹í•˜ëŠ” `í¬ë¡ (Cron)`ì´ë¼ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤.
- Nestì—ì„œ ì¸ê¸° íŒ¨í‚¤ì§€ì¸ node-cronì„ í†µí•©í•œ `@nestjs/schedule` íŒ¨í‚¤ì§€ë¥¼ ì œê³µí•œë‹¤.

```bash
$ npm install --save @nestjs/schedule @types/cron
```

# 14.2 íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§ì„ ì„ ì–¸í•˜ëŠ” 3ê°€ì§€ ë°©ì‹

## 14.2.1 í¬ë¡  ì¡ ì„ ì–¸ ë°©ì‹

- `@Cron` ë°ì»¤ë ˆì´í„°ë¥¼ ì„ ì–¸í•œ ë©”ì„œë“œë¥¼ íƒœìŠ¤í¬ë¡œ êµ¬í˜„í•˜ëŠ” ë°©ì‹.

```tsx
import { Injectable, Logger } from "@nestjs/common";
import { Cron } from "@nestjs/schedule";

// ì˜ì¡´ì„± ì£¼ì… ëŒ€ìƒ ì§€ì •
@Injectable()
export class TaskService {
  // ë¡œê·¸ ì¶œë ¥ ë„êµ¬
  private readonly logger = new Logger(TaskService.name);

  // ì£¼ê¸°ì ì¸ ì‘ì—… ì§€ì • (ë§¤ ì´ˆë§ˆë‹¤ ì‹¤í–‰)
  @Cron("* * * * * *", { name: "cronTask" })
  handleCron() {
    // ì‹¤ì œë¡œ ì‹¤í–‰ë  ë¡œì§, ë¡œê·¸ ì¶œë ¥ ìˆ˜í–‰
    this.logger.log("Task Called");
  }
}
```

### ğŸ“Œ `@Cron()` ë°ì½”ë ˆì´í„°

```tsx
@Cron(cronExpression: string | CronExpression, options?: CronOptions)
```

- `cronExpression` : í¬ë¡  í‘œí˜„ì‹ìœ¼ë¡œ, ì‘ì—…ì´ ì‹¤í–‰ë  ì‹œê°„ íŒ¨í„´ì„ ë¬¸ìì—´ë¡œ ì…ë ¥í•œë‹¤.
  ```tsx
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ second (0 - 59)
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)
  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)
  â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ day of month (1 - 31)
  â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€ month (1 - 12)
  â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€ day of week (0 - 6) (Sunday=0)
  â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
  â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
  * * * * * *
  ```
  | í‘œí˜„ì‹           | ì„¤ëª…                     |
  | ---------------- | ------------------------ |
  | `'* * * * * *'`  | ë§¤ ì´ˆë§ˆë‹¤ ì‹¤í–‰           |
  | `'0 * * * * *'`  | ë§¤ ë¶„ 0ì´ˆë§ˆë‹¤ ì‹¤í–‰       |
  | `'0 0 * * * *'`  | ë§¤ ì‹œê°„ 0ë¶„ 0ì´ˆë§ˆë‹¤ ì‹¤í–‰ |
  | `'0 30 9 * * *'` | ë§¤ì¼ ì˜¤ì „ 9ì‹œ 30ë¶„ 0ì´ˆ   |
  | `'0 0 * * 0'`    | ë§¤ì£¼ ì¼ìš”ì¼ 0ì‹œ 0ë¶„ ì‹¤í–‰ |
- options : ê°ì²´ í˜•íƒœë¡œ ì¶”ê°€ ì˜µì…˜ì„ ì¤„ ìˆ˜ ìˆë‹¤.
  ```tsx
  @Cron('* * * * * *', { name: 'myTask', timeZone: 'Asia/Seoul' })
  ```
  - `name`: ì´ cron ì‘ì—…ì— ë¶™ì¼ ì‹ë³„ì ì´ë¦„ (ë””ë²„ê¹…/ê´€ë¦¬ìš©)
  - `timeZone`: [IANA timezone](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones) ë¬¸ìì—´ì„ ì‚¬ìš©í•´ íƒ€ì„ì¡´ ì§€ì •
  - `startTime`, `endTime`: íŠ¹ì • ê¸°ê°„ì—ë§Œ ì‹¤í–‰ë˜ë„ë¡ ì œí•œ ê°€ëŠ¥
  - `utcOffset`: ì‹œê°„ëŒ€ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì˜¤í”„ì…‹ ì§€ì • (ê¶Œì¥ X, `timeZone` ì‚¬ìš© ê¶Œì¥)

## 14.2.2 ì¸í„°ë²Œ ì„ ì–¸ ë°©ì‹

- ì¼ì • ì‹œê°„ ê°„ê²©(ms ë‹¨ìœ„) ìœ¼ë¡œ ë©”ì„œë“œë¥¼ ë°˜ë³µ ì‹¤í–‰í•˜ë„ë¡ ì„¤ì •í•œë‹¤.

```tsx
//
@Interval('intervalTask', 3000)
handleIntervale() {
	this.logger.log('Task Called by interval');
}
```

- `'intervalTask'`: ë°˜ë³µ ì‘ì—…ì— ë¶™ì´ëŠ” ì‹ë³„ì ì´ë¦„. (ì„ íƒì ì´ì§€ë§Œ ê¶Œì¥)
- `3000`: 3ì´ˆë§ˆë‹¤ ë©”ì„œë“œë¥¼ ì‹¤í–‰ (`3000ms = 3ì´ˆ`).

## 14.2.3 íƒ€ì„ì•„ì›ƒ ì„ ì–¸ ë°©ì‹

- ì•±ì´ ì‹¤í–‰ëœ í›„ íƒœìŠ¤í¬ë¥¼ ë‹¨ í•œ ë²ˆë§Œ ìˆ˜í–‰í•œë‹¤.
- ì¸ìˆ˜ëŠ” ì¸í„°ë²Œê³¼ ë™ì¼í•˜ë‹¤.

```tsx
@Timeout('timeoutTask', 5000)
handleTimeout() {
	this.logger.log('Task Called by timeout');
}
```

## ğŸ†š `@Timeout()` vs `@Interval()` vs `@Cron()`

| ë°ì½”ë ˆì´í„°    | ì‹¤í–‰ íšŸìˆ˜ | ê¸°ì¤€ ì‹œê°„ ë‹¨ìœ„ | ìš©ë„ ì˜ˆì‹œ                        |
| ------------- | --------- | -------------- | -------------------------------- |
| `@Timeout()`  | 1íšŒ       | `ms`           | ì‹œì‘ í›„ ì¼ì • ì‹œê°„ ë’¤ ì´ˆê¸°í™” ì‹¤í–‰ |
| `@Interval()` | ë°˜ë³µ      | `ms`           | ì¼ì • ì£¼ê¸°ë¡œ ìƒíƒœ ì²´í¬, ì•Œë¦¼ ë“±   |
| `@Cron()`     | ë°˜ë³µ      | `cron í‘œí˜„ì‹`  | íŠ¹ì • ì‹œê°„ëŒ€ì— ì •ê¸° ì‹¤í–‰          |

## ğŸ” ì‚¬ìš© ì‹œì  ì˜ˆì‹œ

| ìƒí™©                                | ì¶”ì²œ ë°ì½”ë ˆì´í„° |
| ----------------------------------- | --------------- |
| ì•± ì‹œì‘ í›„ 10ì´ˆ ë’¤ ì´ˆê¸° ë°ì´í„° ë¡œë“œ | `@Timeout()`    |
| 5ë¶„ë§ˆë‹¤ ë©”íŠ¸ë¦­ ìˆ˜ì§‘                 | `@Interval()`   |
| ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œì— ë¦¬í¬íŠ¸ ì „ì†¡  | `@Cron()`       |

# 14.3 ë™ì  íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§

- ì•± êµ¬ë™ ì¤‘ íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í–ˆì„ ë•Œ íƒœìŠ¤í¬ë¥¼ ë“±ë¡í•´ì•¼ í•˜ëŠ” ìš”êµ¬ ì‚¬í•­ì´ ìˆì„ ê²½ìš° ì‚¬ìš©.
- ë™ì ìœ¼ë¡œ íƒœìŠ¤í¬ë¥¼ ë“±ë¡/í•´ì¬ í•  ë°©ë²• êµ¬í˜„.
- `SchedulerRegistry`ì—ì„œ ì œê³µí•˜ëŠ” API ì‚¬ìš©.
- ì˜ˆì•½í˜• ê¸°ëŠ¥ì´ ë§ì€ SaaS, ê´€ë¦¬ì íŒ¨ë„, ì´ë²¤íŠ¸ ê¸°ë°˜ ì‹œìŠ¤í…œ ë“±ì— ë§¤ìš° ìœ ìš©í•˜ë‹¤.

```tsx
import { Injectable, Logger } from "@nestjs/common";
import { CronJob } from "cron";
import { SchedulerRegistry } from "@nestjs/schedule";

@Injectable()
export class DynamicTaskService {
  private readonly logger = new Logger(DynamicTaskService.name);

  constructor(private schedulerRegistry: SchedulerRegistry) {}

  addCronJob(name: string, cronTime: string) {
    const job = new CronJob(cronTime, () => {
      this.logger.log(`ì‹¤í–‰ëœ ì‘ì—…: ${name}`);
    });

    this.schedulerRegistry.addCronJob(name, job);
    job.start();

    this.logger.log(`ì‘ì—… ë“±ë¡ë¨: ${name} (${cronTime})`);
  }

  deleteCronJob(name: string) {
    this.schedulerRegistry.deleteCronJob(name);
    this.logger.warn(`ì‘ì—… ì œê±°ë¨: ${name}`);
  }
}
```

## ğŸ§ª ì‚¬ìš© ì˜ˆ (Controller ë˜ëŠ” ë‹¤ë¥¸ Serviceì—ì„œ í˜¸ì¶œ)

```tsx
// ì‹¤í–‰ ì¤‘ ìƒˆë¡œìš´ ì‘ì—…ì„ ë“±ë¡
dynamicTaskService.addCronJob("reportJob", "0 * * * * *"); // ë§¤ ë¶„ 0ì´ˆë§ˆë‹¤

// íŠ¹ì • ì‘ì—… ì œê±°
dynamicTaskService.deleteCronJob("reportJob");
```

# ğŸ’¡ 2êµëŒ€ë¡œ ëª¨ë‹ˆí„°ë§ í•˜ë˜ ë°©ì‹ì„ @nestjs/scheduleë¡œ í•´ê²°í•˜ëŠ” ë°©ë²•

> ì´ì „ íšŒì‚¬ì—ì„œëŠ” íŒ€ì¥ë‹˜ì´ ì˜¤ì „/ì˜¤í›„ 2êµëŒ€ë¡œ íŒ€ì„ êµ¬ì„±í•´ ëª¨ë‹ˆí„°ë§í•˜ê³  ì—ëŸ¬ë¥¼ ë‹´ë‹¹ìì—ê²Œ ì „ë‹¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì—…ë¬´ë¥¼ ì§€ì‹œí–ˆë‹¤. ë‹¹ì‹œì—ëŠ” ê°œë°œìë¡œì„œ ì´ ê³¼ì •ì„ ìë™í™”í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œë©´ì„œë„ êµ¬ì²´ì ì¸ ë°©ë²•ì„ ëª°ë¼ ì œì•ˆí•˜ì§€ ëª»í–ˆë‹¤. í•˜ì§€ë§Œ ì§€ê¸ˆ ë°°ìš´ ìŠ¤ì¼€ì¤„ë§ ë°©ì‹ì„ ì ìš©í•˜ë©´ íš¨ìœ¨ì ìœ¼ë¡œ ê°œì„ í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ ê´€ë ¨ ì˜ˆì œë¥¼ ì°¾ì•„ë³´ì•˜ë‹¤.

## âœ… êµ¬í˜„ ì‹œë‚˜ë¦¬ì˜¤

**ëª©í‘œ**:

1. ì„œë²„ì—ì„œ ë°œìƒí•œ ì—ëŸ¬ ë¡œê·¸ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³ 
2. ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ì—¬
3. ì¼ì • ê¸°ì¤€ ì´ìƒì´ë©´ ë‹´ë‹¹ìì—ê²Œ ì „ì†¡ (ì´ë©”ì¼, Slack, SMS ë“±)

## ğŸ”§ êµ¬ì„± ìš”ì†Œ

| ê¸°ëŠ¥      | ê¸°ìˆ  ì˜ˆì‹œ                               |
| --------- | --------------------------------------- |
| ë¡œê·¸ ì €ì¥ | `winston`, `nestjs-pino`, DB, íŒŒì¼      |
| ìŠ¤ì¼€ì¤„ë§  | `@Cron()` ë˜ëŠ” `@Interval()`            |
| ì•Œë¦¼ ì „ì†¡ | ì´ë©”ì¼(SMTP), Slack Webhook, SMS API ë“± |

```tsx
// log-monitor.service.ts

import { Injectable, Logger } from "@nestjs/common";
import { Cron } from "@nestjs/schedule";
import { MailerService } from "@nestjs-modules/mailer"; // ì˜ˆ: ì´ë©”ì¼ìš©

@Injectable()
export class LogMonitorService {
  private readonly logger = new Logger(LogMonitorService.name);

  constructor(private readonly mailerService: MailerService) {}

  @Cron("0 */5 * * * *") // 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  async monitorErrorLogs() {
    const errorLogs = await this.getErrorLogs(); // ì—ëŸ¬ ë¡œê·¸ ì¡°íšŒ ë¡œì§
    if (errorLogs.length > 0) {
      this.logger.warn(`ì—ëŸ¬ ${errorLogs.length}ê±´ ë°œê²¬ë¨`);
      await this.sendAlert(errorLogs);
    }
  }

  private async getErrorLogs(): Promise<string[]> {
    // íŒŒì¼ ë˜ëŠ” DBì—ì„œ ìµœê·¼ ì—ëŸ¬ ë¡œê·¸ ìˆ˜ì§‘ (ì˜ˆ: ìµœê·¼ 5ë¶„)
    // ì˜ˆ: fs.readFileSync, DB ì¿¼ë¦¬, Sentry API ë“±
    return ["DB connection timeout", "Unhandled exception"];
  }

  private async sendAlert(logs: string[]) {
    // ì´ë©”ì¼ ë˜ëŠ” Slack ë“±ìœ¼ë¡œ ë°œì†¡
    await this.mailerService.sendMail({
      to: "devops@yourdomain.com",
      subject: `[ì•Œë¦¼] ì—ëŸ¬ ë¡œê·¸ ${logs.length}ê±´ ë°œìƒ`,
      text: logs.join("\n"),
    });
  }
}
```

## ğŸ“¬ Slack ì•Œë¦¼ ì˜ˆì‹œ

```tsx
import axios from 'axios';

private async sendSlackAlert(logs: string[]) {
  const webhookUrl = 'https://hooks.slack.com/services/XXX/YYY/ZZZ';

  await axios.post(webhookUrl, {
    text: `ğŸš¨ *ì—ëŸ¬ ${logs.length}ê±´ ê°ì§€ë¨*\n${logs.join('\n')}`,
  });
}
```

## ğŸ§  ì‹¤ì œ ì„œë¹„ìŠ¤ ì ìš© íŒ

| ê³ ë ¤ ì‚¬í•­        | ì„¤ëª…                                                       |
| ---------------- | ---------------------------------------------------------- |
| ë¡œê·¸ ì§‘ê³„ ì‹œìŠ¤í…œ | Sentry, Elasticsearch, Loki ë“±ì„ ë„ì…í•˜ë©´ í™•ì¥ì„±ì´ ì¢‹ìŒ    |
| ì—ëŸ¬ ê¸°ì¤€        | "ìµœê·¼ 10ë¶„ê°„ ì—ëŸ¬ 10ê±´ ì´ìƒ" ê°™ì€ ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§          |
| ì•Œë¦¼ ì±„ë„        | ì´ë©”ì¼, Slack, SMS, ì¹´ì¹´ì˜¤í†¡ ë¹„ì¦ˆë©”ì‹œì§€ ë“±                 |
| ë¹„ë™ê¸° í ì²˜ë¦¬   | ì•Œë¦¼ ì „ì†¡ëŸ‰ì´ ë§ìœ¼ë©´ `BullMQ` ë“±ìœ¼ë¡œ í ì²˜ë¦¬ ì¶”ì²œ          |
| ë°˜ë³µ ì•Œë¦¼ ì œí•œ   | ë™ì¼í•œ ì—ëŸ¬ì— ëŒ€í•´ ì•Œë¦¼ì´ ë°˜ë³µë˜ì§€ ì•Šë„ë¡ ì¿¨ë‹¤ìš´ ë¡œì§ ì¶”ê°€ |
