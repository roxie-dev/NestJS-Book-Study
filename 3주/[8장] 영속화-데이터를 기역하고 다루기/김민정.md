# [8ì¥] ì˜ì†í™”: ë°ì´í„°ë¥¼ ê¸°ë¡í•˜ê³  ë‹¤ë£¨ê¸°

- Node.js ë“œë¼ì´ë²„ê°€ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ê°€ ìˆë‹¤ë©´ ì ìš©í•  ìˆ˜ ìˆë‹¤.
- RDBMS, NoSQL, ORM(TypeORM, Sequelize ë“±)ì„ ì§€ì›í•œë‹¤.

> **ğŸ’¡ ì˜ì†í™”ë€ ?**

- ì¼ë°˜ì ì¸ ì˜ë¯¸ë¡œ, ì–´ë–¤ ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì—ì„œ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡, íŒŒì¼ì´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ê°™ì€ ì˜êµ¬ ì €ì¥ì†Œì— ì €ì¥í•˜ëŠ” ê³¼ì •.
  >

# TypeORMì´ë€?

ê³µì‹ í™ˆí˜ì´ì§€ : https://typeorm.io/

- ë°ì´í„°ë² ì´ìŠ¤ì™€ í”„ë¡œê·¸ë¨ì„ ì—°ê²°í•´ì£¼ëŠ” ë„êµ¬.
- SQLì–¸ì–´ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì–¸ì–´(JS,TS)ë¡œ ì‘ì„±í•œ ì½”ë“œë¥¼ SQLë¡œ ë³€í™˜í•œë‹¤.

## ğŸ“Œ ì‚¬ìš© ë°©ë²•

```tsx
// user.entity.ts

@Entity()
class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @Column()
  age: number;
}
```

- ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” `user`ë¼ëŠ” ì´ë¦„ì˜ í…Œì´ë¸”ê³¼ `id`, `name`, `age`ë¼ëŠ” ì»¬ëŸ¼ì´ ìƒì„±ëœë‹¤.

## ğŸŒŸ ì¥ì 

- ë³µì¡í•œ ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì„ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ì–´ ì¤€ë‹¤.
- ì½”ë“œë¥¼ ë” ì‰½ê²Œ ì‘ì„±í•˜ê³ , íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ì™€ í•¨ê»˜ ì‘ì„±í•˜ì—¬ ì‹¤ìˆ˜ë¥¼ ì¤„ì´ê³ , ê°œë°œìê°€ ë°ì´í„°ë² ì´ìŠ¤ë³´ë‹¤ ì‹¤ì œ í”„ë¡œê·¸ë¨ ê¸°ëŠ¥ì— ë” ì§‘ì¤‘ í•  ìˆ˜ ìˆê²Œ í•œë‹¤.

# 8.1 MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

- DBeaver ì„¤ì • ë°©ë²•
  - https://daslyee.tistory.com/112

# 8.2 TypeORMìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°

- TypeORM ì—°ê²° ë°©ë²•
  https://docs.nestjs.com/techniques/database#typeorm-transactions

```bash
$ pnpm add typeorm @nestjs/typeorm mysql2
```

```tsx
import { Module } from "@nestjs/common";
import { ConfigModule } from "@nestjs/config";
import { TypeOrmModule } from "@nestjs/typeorm";

@Module({
  imports: [
    TypeOrmModule.forRootAsync({
      imports: [ConfigModule],
      useFactory: (configService: ConfigService) => {
        const type = configService.get<string>(envVariableKeys.dbType);
        const host = configService.get<string>(envVariableKeys.dbHost);
        const port = configService.get<number>(envVariableKeys.dbPort);
        const username = configService.get<string>(envVariableKeys.dbUsername);
        const password = configService.get<string>(envVariableKeys.dbPassword);
        const database = configService.get<string>(envVariableKeys.dbDatabase);

        if (!type || !host || !port || !username || !password || !database) {
          throw new Error("Missing required database configuration");
        }

        return {
          type: type as "mysql",
          host,
          port: Number(port),
          username,
          password,
          database,
          entities: [__dirname + "/**/*.entity{.ts,.js}"],
          synchronize: true,
        };
      },
      inject: [ConfigService],
    }),
  ],
})
export class AppModule {}
```

> ğŸ“Œ synchronize ì˜µì…˜ì„ trueë¡œ ì§€ì •í•˜ë©´ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ê³  ë°ì´í„°ë² ì´ìŠ¤ê°€ ì—°ê²°ë  ë•Œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™” ë˜ë¯€ë¡œ ì ˆëŒ€ í”„ë¡œë•ì…˜ì—ì„œëŠ” trueë¡œ ì§€ì •í•˜ë©´ ì•ˆëœë‹¤.

# 8.4 íŠ¸ëœì­ì…˜ ì ìš©

- TypeORMì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ `QueryRunner`ë¥¼ ì´ìš©í•˜ì—¬ ë‹¨ì¼ DB ì»¤ë„¥ì…˜ ìƒíƒœë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë°©ë²•ê³¼, `transaction í•¨ìˆ˜`ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” 2ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤.

# â“ íŠ¸ëœì­ì…˜ ì´ë€?

- íŠ¸ëœì­ì…˜ì€ ì—¬ëŸ¬ ì‘ì—…ì„ í•œ ë²ˆì— ì²˜ë¦¬í•˜ê³ , ì¤‘ê°„ì— ì‹¤íŒ¨í•˜ë©´ ì•„ë¬´ ì¼ë„ ì•ˆ í•œ ê²ƒì²˜ëŸ¼ ë˜ëŒë¦¬ëŠ” ê²ƒì„ ë§í•œë‹¤.

<p align="center">
 <img  src="../../assets/kmj/3/ChatGPT_Image_2025ë…„_4ì›”_9ì¼_ì˜¤í›„_12_33_07.png" >
  <p align="center"><em> > ì¶œì²˜ : ChatGPT Image</em></p>
  </p>

```bash
1. ë‚´ ê³„ì¢Œì—ì„œ ëˆì´ ë¹ ì ¸ ë‚˜ê°„ë‹¤
2. ì¹œêµ¬ ê³„ì¢Œì— ëˆì´ ë“¤ì–´ ê°„ë‹¤.
```

## íŠ¸ëœì­ì…˜ì˜ íŠ¹ì§•(ACID)

- **`ì›ìì„±(Atomicity)`**: ëª¨ ì•„ë‹ˆë©´ ë„! ì „ì²´ê°€ ì„±ê³µí•˜ê±°ë‚˜ ì•„ë¬´ ì¼ë„ ì•ˆ ì¼ì–´ë‚œ ê²ƒì²˜ëŸ¼ ëŒì•„ê°€ê±°ë‚˜.
- **`ì¼ê´€ì„±(Consistency)`**: ë°ì´í„°ëŠ” í•­ìƒ ê·œì¹™ì„ ì§€í‚¨ë‹¤. (ì˜ˆ: ê³„ì¢Œ ì”ì•¡ì€ ë§ˆì´ë„ˆìŠ¤ê°€ ë  ìˆ˜ ì—†ë‹¤)
- **`ê²©ë¦¬ì„±(Isolation)`**: ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì´ ë™ì‹œì— ì‹¤í–‰ë˜ë„ ì„œë¡œ ë°©í•´í•˜ì§€ ì•ŠëŠ”ë‹¤.
- **`ì§€ì†ì„±(Durability)`**: íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë˜ë©´ ê·¸ ê²°ê³¼ëŠ” ì•ˆì „í•˜ê²Œ ì €ì¥ëœë‹¤.

## 8.4.1 QueryRunnerë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•

- QueryRunnerë¥¼ ì´ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ì„ ì™„ì „íˆ ì œì–´í•  ìˆ˜ ìˆë‹¤.

```tsx
import { Injectable } from "@nestjs/common";
import { InjectDataSource } from "@nestjs/typeorm";
import { DataSource } from "typeorm";

@Injectable()
export class UserService {
  constructor(@InjectDataSource() private readonly dataSource: DataSource) {}

  async createUserWithProfile(userData, profileData) {
    // íŠ¸ëœì­ì…˜ ì‹œì‘!
    const queryRunner = this.dataSource.createQueryRunner();
    await queryRunner.connect();
    await queryRunner.startTransaction();

    try {
      // 1. ìœ ì € ë§Œë“¤ê¸°
      const user = await queryRunner.manager.save("User", userData);

      // 2. í”„ë¡œí•„ ë§Œë“¤ê¸°
      profileData.userId = user.id;
      await queryRunner.manager.save("Profile", profileData);

      // ëª¨ë“  ì‘ì—… ì„±ê³µ! => ì»¤ë°‹!!
      await queryRunner.commitTransaction();
      return user;
    } catch (err) {
      // ì¤‘ê°„ì— ì—ëŸ¬ ë°œìƒ!! => ë¡¤ë°±!!
      await queryRunner.rollbackTransaction();
      throw err;
    } finally {
      // ì—°ê²° ì •ë¦¬
      await queryRunner.release();
    }
  }
}
```

## 8.4.2. transaction í•¨ìˆ˜ë¥¼ ì§ì ‘ ì´ìš©í•˜ëŠ” ë°©ë²•

- dataSource ê°ì²´ ë‚´ì˜ transaction í•¨ìˆ˜ë¥¼ ë°”ë¡œ ì´ìš©í•˜ëŠ” ë°©ë²•ì´ë‹¤.
- transaction ë©”ì„œë“œëŠ” `EntityManager`ë¥¼ ì½œë°±ìœ¼ë¡œ ë°›ì•„ ì‚¬ìš©ìê°€ ì–´ë–¤ ì‘ì—…ì„ ìˆ˜í–‰í•  í•¨ìˆ˜ë¥¼ ì‘ì„± í•  ìˆ˜ ìˆê²Œ í•œë‹¤.

> transaction ë©”ì„œë“œëŠ” ì£¼ì–´ì§„ í•¨ìˆ˜ ì‹¤í–‰ì„ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë˜í•‘í•©ë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ì—°ì‚°ì€ ì œê³µëœ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ì´ìš©í•˜ì—¬ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

```tsx
import { Injectable } from "@nestjs/common";
import { InjectDataSource } from "@nestjs/typeorm";
import { DataSource } from "typeorm";
import { User } from "./entities/user.entity";
import { Profile } from "./entities/profile.entity";

@Injectable()
export class UserService {
  constructor(@InjectDataSource() private readonly dataSource: DataSource) {}

  async createUserWithProfile(userData, profileData) {
    // íŠ¸ëœì­ì…˜ ì‹œì‘
    return this.dataSource.transaction(async (manager) => {
      // 1. ìœ ì € ì €ì¥
      const user = await manager.save(User, userData);

      // 2. í”„ë¡œí•„ ì €ì¥ (user.id ì—°ê²°)
      const profile = new Profile();
      profile.userId = user.id;
      profile.nickname = profileData.nickname;

      // íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ DB ì¡°ì‘
      // save()ë¥¼ ì—¬ëŸ¬ ë²ˆ í•˜ë”ë¼ë„ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì „ì²´ ë¡¤ë°±
      await manager.save(Profile, profile);

      return user;
    });
  }
}
```

# 8.5 ë§ˆì´ê·¸ë ˆì´ì…˜

> 'ì½”ë“œì— ì ì€ í…Œì´ë¸” ì„¤ê³„'ë¥¼ DBì— ë°˜ì˜í•˜ëŠ” ì•ˆì „í•œ ë°©ë²•!

- ë„“ì€ ì˜ë¯¸ì—ì„œ `ë§ˆì´ê·¸ë ˆì´ì…˜(migration)`ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ êµ¬ë™ ë˜ëŠ” OSë¥¼ ë°”ê¾¸ê±°ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ MySQLì—ì„œ Oracleë¡œ ë°”ê¾¸ëŠ” ê²ƒê³¼ ê°™ì´ ì¸í”„ë¼ë¥¼ êµì²´í•˜ëŠ” ê²ƒì„ í¬í•¨í•œë‹¤.
- TypeORMì€ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‰½ê³  ì•ˆì „í•˜ê²Œ í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•œë‹¤.

# â“ ë§ˆì´ê·¸ë ˆì´ì…˜ ì—†ì´ë„ TypeORMìœ¼ë¡œ DBë¥¼ ë§Œë“¤ê³  ì“¸ ìˆ˜ ìˆëŠ”ë° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”?

- **ë¡œì»¬ í™˜ê²½**ì—ì„œëŠ” EntityíŒŒì¼ì„ ì½ì–´ì„œ TypeOrmModuleì„ ì„¤ì •í•˜ì—¬ ìë™ìœ¼ë¡œ DBë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

```tsx
// app.module.ts

TypeOrmModule.forRoot({
  ...,
  synchronize: true,  // TypeORMì´ ìë™ìœ¼ë¡œ DB í…Œì´ë¸” ìƒì„±.
})
```

- **ìš´ì˜ í™˜ê²½**ì—ì„œëŠ” í…Œì´ë¸” êµ¬ì¡°ê°€ ë³€ê²½ë˜ê±°ë‚˜, ë³€ê²½ëœ ê¸°ë¡ì„ ì¶”ì í•˜ê¸° í˜ë“¤ê³  ìë™ìœ¼ë¡œ ë³€ê²½ë˜ë©´ í° ì‚¬ê³ ì˜ ìœ„í—˜ì´ ìˆìœ¼ë¯€ë¡œ, `synchronize: false` ë¡œ ì„¤ì •í•˜ê³  ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ë”°ë¡œ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.
- ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ë©´
  ```tsx
  â€¢ í…Œì´ë¸” ë³€ê²½ ë‚´ì—­ ì¶”ì 
  â€¢ ë¡¤ë°± ê°€ëŠ¥
  â€¢ íŒ€ í˜‘ì—…ì— ê°•í•¨
  ```

## ğŸ§­ ì „ì²´ íë¦„

### 1. CLI ì„¤ì •í•˜ê¸° (typeorm ëª…ë ¹ì–´ë¥¼ ì“°ê¸° ìœ„í•œ ì„¤ì •)

```json
// package.json

"scripts": {
  "typeorm": "typeorm-ts-node-commonjs"
}
```

### 2. `ormconfig.ts` ëŒ€ì‹  `data-source.ts` ì‚¬ìš©í•˜ê¸° (TypeORM v0.3 ì´ìƒ)

```tsx
// src/data-source.ts

import { DataSource } from "typeorm";
import { User } from "./user/user.entity"; // ì˜ˆì‹œ ì—”í‹°í‹°

export const AppDataSource = new DataSource({
  type: "mysql",
  host: "localhost",
  port: 3306,
  username: "root",
  password: "",
  database: "test",
  entities: [User],
  migrations: ["src/migrations/*.ts"],
  synchronize: false, // ì‹¤ì„œë²„ì—ì„œëŠ” ê¼­ false!
});
```

### 3. ì—”í‹°í‹° ë§Œë“¤ê¸° (ì˜ˆ: User)

```tsx
// src/user/user.entity.ts

import { Entity, Column, PrimaryGeneratedColumn } from "typeorm";

@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;
}
```

### 4. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±í•˜ê¸°

```bash
# User ì—”í‹°í‹°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ CreateUserTableì´ë¼ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ src/migrations í´ë”ì— ìƒì„±
$ npx typeorm migration:generate src/migrations/CreateUserTable -d src/data-source.ts
```

### 5. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰í•˜ê¸° (DBì— í…Œì´ë¸” ì‹¤ì œ ìƒì„±)

```bash
$ npx typeorm migration:run -d src/data-source.ts
```

### 6. ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ëŒë¦¬ê¸° (rollback)

```bash
$ npx typeorm migration:revert -d src/data-source.ts
```

# [ì‰¬ì–´ ê°€ëŠ” í˜ì´ì§€] ì €ì¥ì†Œ íŒ¨í„´

- ì €ì¥ì†Œ íŒ¨í„´(Repository Pattern)ì€ ë°ì´í„°ë² ì´ìŠ¤ì™€ ê°™ì€ ì €ì¥ì†Œë¥¼ ë‹¤ë£¨ëŠ” ë¡œì§ì„ ë°ì´í„° ë ˆì´ì–´ë¡œ ë¶„ë¦¬í•˜ì—¬ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
- ì—¬ê¸°ì„œ ì €ì¥ì†ŒëŠ” `ì˜ˆ: UserRepository`ë¥¼ ê°€ë¥´í‚¨ë‹¤.

<p align="center">
 <img  src="../../assets/kmj/3/image.png" >
  <p align="center"><em> > ì¶œì²˜ : p.151 NestJSë¡œ ë°°ìš°ëŠ” ë°±ì—”ë“œ í”„ë¡œê·¸ë˜ë°</em></p>
  </p>
